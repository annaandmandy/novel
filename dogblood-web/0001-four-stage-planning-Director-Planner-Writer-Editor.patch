From a9b0d61c26710a0887bd224a99c1fe872349d518 Mon Sep 17 00:00:00 2001
From: annaandmandy <annaandtommy1004@gmail.com>
Date: Wed, 3 Dec 2025 17:27:06 -0500
Subject: [PATCH] four stage planning - Director, Planner, Writer, Editor

---
 dogblood-web/ios/App/App/config 2.xml |   6 ++
 dogblood-web/ios/App/App/config 3.xml |   6 ++
 dogblood-web/src/lib/gemini.js        | 114 ++++++++++++++++++++++++--
 dogblood-web/src/pages/Reader.jsx     |  24 +++++-
 4 files changed, 143 insertions(+), 7 deletions(-)
 create mode 100644 dogblood-web/ios/App/App/config 2.xml
 create mode 100644 dogblood-web/ios/App/App/config 3.xml

diff --git a/dogblood-web/ios/App/App/config 2.xml b/dogblood-web/ios/App/App/config 2.xml
new file mode 100644
index 0000000..1b1b0e0
--- /dev/null
+++ b/dogblood-web/ios/App/App/config 2.xml	
@@ -0,0 +1,6 @@
+<?xml version='1.0' encoding='utf-8'?>
+<widget version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
+  <access origin="*" />
+  
+  
+</widget>
\ No newline at end of file
diff --git a/dogblood-web/ios/App/App/config 3.xml b/dogblood-web/ios/App/App/config 3.xml
new file mode 100644
index 0000000..1b1b0e0
--- /dev/null
+++ b/dogblood-web/ios/App/App/config 3.xml	
@@ -0,0 +1,6 @@
+<?xml version='1.0' encoding='utf-8'?>
+<widget version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
+  <access origin="*" />
+  
+  
+</widget>
\ No newline at end of file
diff --git a/dogblood-web/src/lib/gemini.js b/dogblood-web/src/lib/gemini.js
index e3fbdd3..03b22c4 100644
--- a/dogblood-web/src/lib/gemini.js
+++ b/dogblood-web/src/lib/gemini.js
@@ -179,6 +179,84 @@ const callOpenRouterPipeline = async (systemPrompt, userPrompt) => {
     }
 };
 
+// ==========================================
+// æ ¸å¿ƒ Agent å‡½æ•¸ç¾¤ (The AI Editorial Room)
+// ==========================================
+
+/**
+ * ðŸ•µï¸ ç­–åŠƒ Agent (The Planner)
+ * è² è²¬æ ¹æ“šã€Œå°Žæ¼”æŒ‡ä»¤ã€èˆ‡ã€Œè¨­è¨ˆåœ–ã€ï¼Œç”Ÿæˆå…·é«”çš„å–®ç« å¤§ç¶±èˆ‡ä¼ç­†ã€‚
+ */
+const planChapter = async (director, blueprint, contextSummary) => {
+    const model = getGeminiModel(true); // JSON mode
+
+    const prompt = `
+    ä½ æ˜¯ä¸€ä½å°èªªåŠ‡æƒ…ç­–åŠƒï¼ˆPlot Architectï¼‰ã€‚
+    è«‹æ ¹æ“šã€å°Žæ¼”ç¯€å¥ã€‘èˆ‡ã€ä¸–ç•Œè§€è—åœ–ã€‘ï¼Œç‚ºä¸‹ä¸€ç« æ’°å¯«è©³ç´°çš„åŠ‡æƒ…å¤§ç¶±ã€‚
+    
+    ã€å°Žæ¼”æŒ‡ä»¤ (æœ¬ç« ç¯€å¥)ã€‘
+    ${director.directive}
+    
+    ã€è¨­è¨ˆåœ– (çµ‚æ¥µç›®æ¨™)ã€‘
+    ${blueprint}
+    
+    ã€å‰æƒ…æè¦ã€‘
+    ${contextSummary}
+    
+    ã€ä»»å‹™ã€‘
+    1. æ€è€ƒå¦‚ä½•å°‡ã€Œè¨­è¨ˆåœ–ã€ä¸­çš„çµ‚æ¥µè¬Žé¡Œæ‹†è§£ï¼Œåœ¨æœ¬ç« ä¸­åŸ‹ä¸‹ä¸€å€‹å¾®å°çš„ä¼ç­†æˆ–ç·šç´¢ã€‚
+    2. è¨­è¨ˆæœ¬ç« çš„æ ¸å¿ƒè¡çªé»ž (Conflict) èˆ‡è§£æ±ºæ–¹å¼ (Resolution)ã€‚
+    3. è¦åŠƒæ„Ÿæƒ…ç·šçš„å…·é«”äº’å‹•å ´æ™¯ã€‚
+    
+    è«‹å›žå‚³ JSON:
+    {
+        "chapter_title": "æœ¬ç« æš«å®šæ¨™é¡Œ",
+        "outline": "è©³ç´°çš„åŠ‡æƒ…å¤§ç¶± (ç´„ 200-300 å­—)ï¼ŒåŒ…å«èµ·æ‰¿è½‰åˆã€‚",
+        "key_clue": "æœ¬ç« éœ€è¦æ­éœ²æˆ–åŸ‹ä¸‹çš„é—œéµç·šç´¢ (è‹¥æœ‰)",
+        "romance_moment": "æœ¬ç« çš„æ„Ÿæƒ…é«˜å…‰æ™‚åˆ»è¨­è¨ˆ"
+    }
+    `;
+
+    try {
+        const result = await model.generateContent(prompt);
+        return cleanJson(result.response.text());
+    } catch (e) {
+        console.warn("Planning failed, falling back to direct writing.", e);
+        return null; // å¤±æ•—å‰‡å›žå‚³ nullï¼Œè®“ Writer è‡ªå·±ç™¼æ®
+    }
+};
+
+/**
+ * âœï¸ ç·¨è¼¯ Agent (The Editor)
+ * è² è²¬æ½¤è‰²åˆç¨¿ã€‚
+ */
+const polishContent = async (draft, tone, pov) => {
+    const model = getGeminiModel(false); // Text mode
+
+    const editorPrompt = `
+    ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ç¶²æ–‡ä¸»ç·¨ã€‚è«‹å°ä»¥ä¸‹å°èªªåˆç¨¿é€²è¡Œã€æ·±åº¦æ½¤è‰²ã€‘ã€‚
+    
+    ã€æ½¤è‰²ç›®æ¨™ï¼šå•†æ¥­å‡ºç‰ˆç´šåˆ¥ã€‘
+    1. **åŽ»é™¤ AI æ„Ÿ**ï¼šåˆªé™¤é‡è¤‡çš„é€£æŽ¥è©žã€éŽåº¦ç”Ÿç¡¬çš„å¿ƒç†ç¨ç™½ã€‚
+    2. **å¢žå¼·ç•«é¢æ„Ÿ**ï¼šShow, Don't Tellã€‚
+    3. **é¢¨æ ¼å¼·åŒ–**ï¼š
+       - ${tone === 'çˆ½æ–‡' ? 'åŠ å¼·æƒ…ç·’ç…½å‹•åŠ›ï¼Œç”¨è©žè¦ç‹ ã€‚' : ''}
+       - ${tone === 'è™æˆ€' ? 'åŠ å¼·æ°›åœæ¸²æŸ“ï¼Œç”¨è©žè¦å”¯ç¾Žæªå¿ƒã€‚' : ''}
+    
+    ã€æ³¨æ„ã€‘ä¿ç•™åŽŸæœ‰åŠ‡æƒ…ï¼Œç›´æŽ¥è¼¸å‡ºæ½¤è‰²å¾Œçš„æ­£æ–‡ã€‚
+    
+    [åˆç¨¿å…§å®¹]
+    ${draft}
+    `;
+
+    try {
+        const result = await model.generateContent(editorPrompt);
+        return result.response.text();
+    } catch (e) {
+        return draft;
+    }
+};
+
 // ==========================================
 // 1. ç”Ÿæˆåˆå§‹è¨­å®š (å·²æ›´æ–°ï¼šæŽ¥æ”¶ targetChapterCount, category)
 // ==========================================
@@ -600,13 +678,15 @@ const determinePlotDirectives = (currentChapterIndex, lastPlotState, genre, tags
 // 3. ç”Ÿæˆä¸‹ä¸€ç« 
 // ==========================================
 export const generateNextChapter = async (novelContext, previousContent, characters = [], memories = [], tags = [], tone = "ä¸€èˆ¬", pov = "å¥³ä¸»", lastPlotState = null) => {
-    // é è¨­ç« ç¯€æ•¸é‚è¼¯ï¼šå„ªå…ˆä½¿ç”¨ novelContext.targetEndingChapterï¼Œè‹¥ç„¡å‰‡æ ¹æ“š Genre è‡ªå‹•åˆ¤æ–·
     const totalChapters = novelContext.targetEndingChapter || getRecommendedTotalChapters(novelContext.genre);
 
+    // 1. Director (Logic)
     const director = determinePlotDirectives(novelContext.currentChapterIndex, lastPlotState, novelContext.genre, tags, totalChapters);
+
     const toneDesc = getToneInstruction(tone);
     const povDesc = getPovInstruction(pov);
     const styleGuide = `é¡žåž‹ï¼š${novelContext.genre} | é¢¨æ ¼æ¨™ç±¤ï¼š${tags.join('ã€')}ã€‚\n${toneDesc}\n${povDesc}`;
+    const blueprintStr = JSON.stringify(novelContext.design_blueprint || {});
 
     const charText = characters.map(c => {
         const profile = typeof c.profile === 'string' ? JSON.parse(c.profile) : c.profile;
@@ -615,7 +695,16 @@ export const generateNextChapter = async (novelContext, previousContent, charact
     }).join('\n');
 
     const memText = memories.slice(0, 15).map(m => `- ${m.content}`).join('\n');
-    const blueprint = JSON.stringify(novelContext.design_blueprint || {});
+    const prevText = previousContent.slice(-1500);
+
+    // 2. Planner (Creative Agent)
+    console.log("ðŸ§  Planner Agent is working...");
+    const chapterPlan = await planChapter(director, blueprintStr, prevText);
+
+    // å¦‚æžœç­–åŠƒæˆåŠŸï¼Œå°‡å¤§ç¶±æ³¨å…¥ Promptï¼›å¦‚æžœå¤±æ•—ï¼Œå‰‡åƒ…ä½¿ç”¨å°Žæ¼”æŒ‡ä»¤
+    const outlineContext = chapterPlan ?
+        `ã€æœ¬ç« åŠ‡æƒ…å¤§ç¶± (ç”±ç­–åŠƒ Agent æä¾›)ã€‘\næ¨™é¡Œï¼š${chapterPlan.chapter_title}\nå¤§ç¶±ï¼š${chapterPlan.outline}\né—œéµç·šç´¢ï¼š${chapterPlan.key_clue}\næ„Ÿæƒ…é«˜å…‰ï¼š${chapterPlan.romance_moment}` :
+        "";
 
     // çµå±€å€’æ•¸é‚è¼¯
     let endingInstruction = "";
@@ -632,13 +721,15 @@ export const generateNextChapter = async (novelContext, previousContent, charact
     ç•¶å‰å·å/å‰¯æœ¬ï¼š${director.arcName}
     
     ã€è¨­è¨ˆåœ– (å°Žèˆª)ã€‘
-    ${blueprint}
+    ${blueprintStr}
     (å¯«ä½œæ™‚è«‹æ™‚åˆ»è¨˜å¾—ã€Œçµ‚æ¥µç›®æ¨™ã€èˆ‡ã€Œä¸–ç•ŒçœŸç›¸ã€ï¼Œç¢ºä¿åŠ‡æƒ…ä¸è·‘å)
 
-    ã€æœ¬ç« å°Žæ¼”æŒ‡ä»¤ (é‡è¦)ã€‘
+    ã€æœ¬ç« å°Žæ¼”æŒ‡ä»¤ (é‚è¼¯å±¤)ã€‘
     ${director.directive}
     ${endingInstruction}
     
+    ${outlineContext}
+    
     ã€é¡é ­èªžè¨€è¦æ±‚ã€‘
     æ•˜äº‹æ™‚è«‹è‡ªç„¶èžå…¥ã€Œé›»å½±åˆ†é¡æ„Ÿã€ï¼ŒåŒ…å«ï¼š
     - å…‰ç·šï¼ˆäº®åº¦ã€æ–¹å‘ã€å ´æ™¯æ°›åœï¼‰
@@ -659,7 +750,7 @@ export const generateNextChapter = async (novelContext, previousContent, charact
     ã€ä¸Šä¸‹æ–‡ã€‘
     è¨˜æ†¶åº«ï¼š${memText}
     è§’è‰²ç‹€æ…‹ï¼š${charText}
-    å‰æ–‡æ‘˜è¦ï¼š${previousContent.slice(-1500)}
+    å‰æ–‡æ‘˜è¦ï¼š${prevText}
 
     ã€å›žå‚³ JSONã€‘
     {
@@ -682,10 +773,21 @@ export const generateNextChapter = async (novelContext, previousContent, charact
     `;
 
     try {
+        // 3. Writer (Gemini)
         const geminiModel = getGeminiModel(true);
         const geminiPrompt = baseSystemPrompt + "\n" + geminiUserPrompt + `\n å›žå‚³ JSON Schema è«‹åŒ…å« plot_state`;
         const result = await geminiModel.generateContent(geminiPrompt);
-        return cleanJson(result.response.text());
+        const jsonResponse = cleanJson(result.response.text());
+
+        // 4. Editor (Gemini - Text Mode)
+        // åªæœ‰ç•¶ç”ŸæˆæˆåŠŸä¸”å…§å®¹å……è¶³æ™‚æ‰é€²è¡Œæ½¤è‰²ï¼Œé¿å…æµªè²» Token æˆ–ç ´å£žæ ¼å¼
+        if (jsonResponse.content && jsonResponse.content.length > 500) {
+            console.log("âœï¸ Editor Agent is polishing Chapter...");
+            const polishedContent = await polishContent(jsonResponse.content, tone, pov);
+            jsonResponse.content = polishedContent;
+        }
+
+        return jsonResponse;
 
     } catch (error) {
         if (isGeminiBlockedError(error)) {
diff --git a/dogblood-web/src/pages/Reader.jsx b/dogblood-web/src/pages/Reader.jsx
index 2fc604f..c867286 100644
--- a/dogblood-web/src/pages/Reader.jsx
+++ b/dogblood-web/src/pages/Reader.jsx
@@ -195,7 +195,8 @@ export default function Reader() {
                 memories,
                 novel.tags || [],
                 novel.settings?.tone,
-                novel.settings?.pov
+                novel.settings?.pov,
+                novel.settings?.plot_state // Pass lastPlotState
             );
 
             // 2. Handle DB Updates
@@ -308,6 +309,27 @@ export default function Reader() {
                 updates.push(fetchWikiData());
             }
 
+            // D. Update Plot State in Novel Settings
+            if (aiResponse.plot_state) {
+                const newSettings = {
+                    ...novel.settings,
+                    plot_state: aiResponse.plot_state
+                };
+
+                updates.push(
+                    supabase.from('novels')
+                        .update({ settings: newSettings })
+                        .eq('id', novel.id)
+                        .then(({ error }) => {
+                            if (error) console.error("Failed to update plot state:", error);
+                            else {
+                                // Update local state to reflect change immediately
+                                setNovel(prev => ({ ...prev, settings: newSettings }));
+                            }
+                        })
+                );
+            }
+
             await Promise.all(updates);
 
         } catch (error) {
-- 
2.50.1 (Apple Git-155)

